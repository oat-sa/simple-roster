# Development in docker environment

> Purpose of this document is to describe how to set up and use the application in docker environment.

## Table of contents

- [Installation](#installation)
- [Testing](#testing)
    
## Installation

The application comes with a built-in containerized development environment built on top of [OAT Docker Stack](https://github.com/oat-sa/docker-stack). 
In order to install it please follow the installation steps in it's [README](https://github.com/oat-sa/docker-stack#installation) file.

Next step is to create your `.env.local` file in application root directory.

```shell script
$ printf '%s\n%s\n' 'COMPOSER_AUTH={"github-oauth":{"github.com":"your token here"}}' 'COMPOSER_HOME=~/.composer' >> .env.local
```

Then update your Composer settings such as path to your `COMPOSER_HOME` and `COMPOSER_AUTH` GitHub credentials.

It should look something like this:

```dotenv
COMPOSER_AUTH={"github-oauth":{"github.com":"your token here"}}
COMPOSER_HOME=~/.composer
```

The rest of the configuration is pre-configured with the `.env.docker` file, so next step is to set up the containers:

```shell script
$ docker-compose --env-file .env.local up -d
```

Then install application dependencies:

```shell script
$ docker container exec -it simple-roster-phpfpm composer install
```

The following section is optional and is applicable only if you are using [OAT Docker Stack](https://github.com/oat-sa/docker-stack).
In order to install it please follow the installation steps in it's [README](https://github.com/oat-sa/docker-stack#installation) file.

> The application is *NOT* exposed on any port by default. It be automatically available at `https://simple-roster.docker.localhost` DNS host.
> If your system cannot resolve the domain, you might want to check [this article](https://github.com/oat-sa/docker-stack#how-to-redirect-dockerlocalhost-dns-queries-to-localhost) about how to redirect `.docker.localhost` DNS queries to your localhost.

## Testing

### PHPUnit

To run the full test suite execute:

```shell script
$ docker container exec -it simple-roster-phpfpm bash -c "source .env.test && bin/phpunit"
```

If you receive an error message about not finding the bootstrap files:

__(bin/.phpunit/phpunit-8.3-0/vendor/composer/../symfony/phpunit-bridge/bootstrap.php): failed to open stream: No such file or directory ...)__

try to delete the autogenerated phpunit folder:

```shell script
$ docker container exec -it simple-roster-phpfpm rm -rf bin/.phpunit
```

and execute the command again.

### Infection

To run infection suite execute:

```shell script
$ docker container exec -it simple-roster-phpfpm bash -c "source .env.test && vendor/bin/infection --threads=$(nproc)"
```

If you receive an error message about not finding the bootstrap files:

__(bin/.phpunit/phpunit-8.3-0/vendor/composer/../symfony/phpunit-bridge/bootstrap.php): failed to open stream: No such file or directory ...)__

try to delete the autogenerated phpunit folder:

```shell script
$ docker container exec -it simple-roster-phpfpm rm -rf bin/.phpunit
```

and execute the command again.
