# Keeping sensitive information secret with Vault

Environment variables are the best way to store configuration that depends on where the application is run - for example, 
some API key that might be set to one value while developing locally and another value on production.

When these values are sensitive and need to be kept private, you can safely store them by using Symfony’s secrets management system - sometimes called a “vault”.

- [Generate cryptographic keys](#generate-cryptographic-keys)
- [Create or update secrets](#create-or-update-secrets)
- [List existing secrets](#list-existing-secrets)
- [Remove secrets](#remove-secrets)
- [Deploy secrets to production](#deploy-secrets-to-production)
- [Rotating secrets](#rotating-secrets)

## Generate cryptographic keys

In order to encrypt and decrypt secrets, Symfony needs cryptographic keys. A pair of keys can be generated by running:

```shell script
$ sudo -u www-data bin/console secrets:generate-keys --env=prod
```

This will generate a pair of asymmetric cryptographic keys. Each environment has its own set of keys. For production environment, this will create:

`config/secrets/prod/prod.encrypt.public.php`

Used to encrypt/add secrets to the vault.

`config/secrets/prod/prod.decrypt.private.php`

Used to decrypt/read secrets from the vault.

## Create or update secrets

Suppose you want to store your database password as a secret. By using the `secrets:set` command, you should add this secret to the prod vault:

```shell script
# The input is hidden as you type for security reasons
$ sudo -u www-data bin/console secrets:set DATABASE_PASSWORD --env=prod
```

This will create a new file for the secret in `config/secrets/prod` folder.

Secret values can be referenced in the same way as environment variables. 

**Be careful that you don’t accidentally define a secret and an environment variable with the same name: environment variables override secrets.**

## List existing secrets

Everybody is allowed to list the secrets names with the command `secrets:list`. If you have the decryption key you can also reveal the secrets’ values by passing the `--reveal` option

```shell script
$ sudo -u www-data bin/console secrets:list --reveal

------------------- ------------ -------------
Name                Value        Local Value
------------------- ------------ -------------
DATABASE_PASSWORD   "my secret"
------------------- ------------ -------------
```

## Remove secrets

To remove a secret you can run:

```shell script
$ sudo -u www-data bin/console secrets:remove DATABASE_PASSWORD
```

## Deploy secrets to production

Due to the fact that decryption keys should never be committed, you will need to manually store this file somewhere and deploy it. 
There are two ways to do that:

1. Uploading the file

The first option is to copy the production decryption key - `config/secrets/prod/prod.decrypt.private.php` to your server.

2. Using an Environment Variable

The second way is to set the `SYMFONY_DECRYPTION_SECRET` environment variable to the base64 encoded value of the production decryption key. 
A fancy way to fetch the value of the key is:

```shell script
# this command only gets the value of the key; you must also set an env var
# in your system with this value (e.g. `export SYMFONY_DECRYPTION_SECRET=...`)
$ php -r 'echo base64_encode(require "config/secrets/prod/prod.decrypt.private.php");'
```

To improve performance (i.e. avoid decrypting secrets at runtime), you can decrypt your secrets during deployment to the “local” vault:

```shell script
$ sudo -u www-data bin/console secrets:decrypt-to-local --force --env=prod
```

This will write all the decrypted secrets into the `.env.prod.local` file. After doing this, the decryption key does not need to remain on the server(s).

## Rotating secrets

The `secrets:generate-keys` command provides a `--rotate` option to regenerate the cryptographic keys. 
The application will decrypt existing secrets with the old key, generate new cryptographic keys and re-encrypt secrets with the new key. 
In order to decrypt previous secrets, you must have the decryption key.
      